@base           <http://atomgraph.com/blog/ns> .

#@prefix :       <#> .
@prefix gc:     <http://atomgraph.com/client/ns#> .
@prefix rdf:    <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs:   <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd:    <http://www.w3.org/2001/XMLSchema#> .
@prefix owl:    <http://www.w3.org/2002/07/owl#> .
@prefix skos:   <http://www.w3.org/2004/02/skos/core#> .
@prefix ldt:    <http://www.w3.org/ns/ldt#> .
@prefix core:   <http://www.w3.org/ns/ldt/core#> .
@prefix dh:     <http://www.w3.org/ns/ldt/document-hierarchy#> .
@prefix sd:     <http://www.w3.org/ns/sparql-service-description#> .
@prefix sp:     <http://spinrdf.org/sp#> .
@prefix spin:   <http://spinrdf.org/spin#> .
@prefix spl:    <http://spinrdf.org/spl#> .
@prefix dct:    <http://purl.org/dc/terms/> .
@prefix void:   <http://rdfs.org/ns/void#> .
@prefix sioc:   <http://rdfs.org/sioc/ns#> .
@prefix foaf:   <http://xmlns.com/foaf/0.1/> .

<#> a owl:Ontology, ldt:Ontology ;
    owl:imports dh:, sioc:, skos: ;
    rdfs:label "Blog ontology" ;
    dct:created "2014-10-21T01:53:00+01:00"^^xsd:dateTime .

# TEMPLATES

core:SPARQLEndpoint gc:supportedMode gc:ReadMode, gc:ListMode, gc:TableMode, gc:MapMode .

# posts

<#Forum> a rdfs:Class, owl:Class, ldt:Template ;
    rdfs:subClassOf dh:Container, sioc:Forum ;
    ldt:path "/posts/" ;
    ldt:param [ a ldt:Argument ;
        spl:predicate dh:limit ;
        spl:defaultValue 20 ;
        spl:optional true ;
        ldt:tunnel true
    ] , [ a ldt:Argument ;
        spl:predicate gc:mode ;
        spl:valueType gc:PageMode ;
        spl:optional true ;
        spl:defaultValue gc:ListMode
    ] , [ a ldt:Argument ;
        spl:predicate gc:forClass ;
        spl:valueType rdfs:Class ;
        spl:optional true
    ] ;
    gc:defaultMode gc:ReadMode ;
    gc:supportedMode gc:ReadMode, gc:ListMode, gc:TableMode, gc:ThumbnailMode ;
    rdfs:label "Forum" ;
    rdfs:isDefinedBy <#> .

<#Post> a rdfs:Class, owl:Class, ldt:Template ;
    rdfs:subClassOf core:Document, sioc:Post ;
    ldt:path "/posts/{slug}" ;
    ldt:update ldt:Delete ;
    spin:constructor
        [ a       sp:Construct ;
          sp:text """
              PREFIX blog:    <http://atomgraph.com/blog/ns#>
              PREFIX xsd:     <http://www.w3.org/2001/XMLSchema#>
              PREFIX sioc:    <http://rdfs.org/sioc/ns#>
              PREFIX dh:      <http://www.w3.org/ns/ldt/document-hierarchy#>
              PREFIX dct:     <http://purl.org/dc/terms/>

              CONSTRUCT {
                  ?this dct:title [ a xsd:string ] ;
                      sioc:content [ a xsd:string ] ;
                      dct:subject [ a blog:Category ] .
              }
              WHERE {}"""
        ] ;
    spin:constraint [ a ldt:MissingPropertyValue ;
	    sp:arg2 dct:title
	] ,
        [ a ldt:MissingPropertyValue ;
	    sp:arg2 sioc:content
	] ;
    ldt:cacheControl "public, max-age=3600" ;
    gc:supportedMode gc:ReadMode, gc:EditMode ;
    gc:defaultMode gc:ReadMode ;
    rdfs:label "Post" ;
    rdfs:isDefinedBy <#> .

# categories

<#CategoryContainer> a rdfs:Class, owl:Class, ldt:Template ;
    rdfs:subClassOf dh:Container ;
    ldt:path "/categories/" ;
    ldt:param [ a ldt:Argument ;
        spl:predicate dh:limit ;
        spl:defaultValue 20 ;
        spl:optional true ;
        ldt:tunnel true
    ] , [ a ldt:Argument ;
        spl:predicate gc:mode ;
        spl:valueType gc:PageMode ;
        spl:defaultValue gc:ReadMode ;
        spl:optional true ;
        ldt:tunnel true
    ] , [ a ldt:Argument ;
        spl:predicate gc:forClass ;
        spl:valueType rdfs:Class ;
        spl:optional true
    ] ;
    gc:defaultMode gc:ReadMode ;
    gc:supportedMode gc:ReadMode, gc:ListMode, gc:TableMode, gc:ThumbnailMode ;
    rdfs:label "Category container" ;
    rdfs:isDefinedBy <#> .

<#CategoryDocument> a rdfs:Class, owl:Class, ldt:Template ;
    rdfs:subClassOf core:Document ,
        [ a owl:Restriction ;
            owl:onProperty foaf:primaryTopic ;
            owl:allValuesFrom <#Category>
	] ;
    ldt:path "/categories/{slug}" ;
    ldt:query
        [ a       sp:Describe ;
            sp:text """
                PREFIX xsd:     <http://www.w3.org/2001/XMLSchema#>
                PREFIX foaf:    <http://xmlns.com/foaf/0.1/>
                PREFIX dct:     <http://purl.org/dc/terms/>

                DESCRIBE ?this ?category ?post {
                    ?category foaf:isPrimaryTopicOf ?this
                    OPTIONAL {
                        SELECT DISTINCT ?post ?category
                        {
                            ?post dct:subject ?category
                        }
                    }
                }"""
        ] ;
    ldt:update core:Delete ; # th:DeleteWithTopic ;
    ldt:cacheControl "public, max-age=3600" ;
    gc:supportedMode gc:ReadMode, gc:EditMode ;
    gc:defaultMode gc:ReadMode ;
    rdfs:label "Category document" ;
    rdfs:isDefinedBy <#> .

<#Category> a rdfs:Class, owl:Class ;
    rdfs:subClassOf skos:Concept,
        [ a owl:Restriction ;
            owl:onProperty foaf:isPrimaryTopicOf ;
            owl:allValuesFrom <#CategoryDocument>
        ] ;
    ldt:skolemTemplate "{isPrimaryTopicOf.slug}" ;
    spin:constructor
        [ a       sp:Construct ;
          sp:text """
              PREFIX skos:    <http://www.w3.org/2004/02/skos/core#>

              CONSTRUCT {
                ?this skos:prefLabel [ a xsd:string ] .
              }
              WHERE {}"""
        ] ;
    spin:constraint [ a ldt:MissingPropertyValue ;
	    sp:arg1 <#Category> ;
	    sp:arg2 skos:prefLabel
	] ;
    rdfs:label "Category" ;
    rdfs:isDefinedBy <#> .